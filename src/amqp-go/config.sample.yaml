# AMQP-Go Server Configuration
# Complete configuration file with all available options and their defaults
# Load with: amqp-server --config config.yaml
# Override any setting with environment variables: AMQP_NETWORK_PORT=15672
#
# ============================================================================
# Metadata Caching Architecture
# ============================================================================
#
# All metadata (exchanges, queues, bindings) is cached in memory using lock-free
# sync.Map structures for O(1) lookup performance. This eliminates disk I/O on
# the critical message routing path.
#
# Benefits:
# - Zero disk reads for routing lookups during message publish
# - Lock-free concurrent access for high-throughput routing
# - Warm cache preloaded on startup (all metadata in memory)
# - O(1) binding lookups (previously O(n) disk scans)
#
# Memory Impact:
# - Exchange metadata: ~1-2 KB per exchange
# - Queue metadata: ~1-2 KB per queue
# - Binding metadata: ~500 bytes per binding
# - Typical setup (100 queues, 200 bindings): ~200 KB total
#
# Cached Metadata:
# ✓ Exchanges - All exchange definitions with properties
# ✓ Queues - All queue definitions with properties
# ✓ Bindings - Three-tier cache (individual, queue-indexed, exchange-indexed)
# ✓ Consumers - Lock-free sync.Map in broker
#
# Cache Invalidation:
# - Automatic on create/update/delete operations
# - Persisted to disk atomically (CBOR format for speed)
# - Rebuilt on server restart (warm cache)
#

# ============================================================================
# Network Configuration
# ============================================================================
network:
  # Server bind address (format: "host:port" or ":port")
  address: :5672

  # AMQP protocol port (standard: 5672, TLS: 5671)
  port: 5672

  # Maximum concurrent client connections
  maxconnections: 1000

  # Connection timeout for initial handshake (milliseconds)
  connectiontimeoutms: 30000  # 30 seconds

  # AMQP heartbeat interval (milliseconds, 0 = disabled)
  heartbeatintervalms: 60000  # 60 seconds

  # Enable TCP keep-alive probes
  tcpkeepalive: true

  # TCP keep-alive probe interval (milliseconds)
  tcpkeepaliveintervalms: 30000  # 30 seconds

  # TCP read buffer size (bytes)
  readbuffersize: 8192

  # TCP write buffer size (bytes)
  writebuffersize: 8192

# ============================================================================
# Storage Configuration
# ============================================================================
storage:
  # Directory path for persistent storage
  path: ./data

  # Enable synchronous writes (fsync after each WAL batch write)
  # true = safer but slower (fsync after each batch)
  # false = faster but less durable (relies on OS page cache)
  fsync: false

  # Message TTL in seconds (0 = no expiration)
  messagettl: 0

  # Metadata cache size in megabytes
  cachemb: 64

  # Maximum number of open file handles
  maxfiles: 100

  # Retention period for old segments (milliseconds)
  # Example: 86400000 = 24 hours
  retentionms: 86400000

  # Interval for checkpointing consumer offsets to disk (milliseconds)
  # Set to 0 to disable background checkpointing (manual checkpoint only)
  checkpointintervalms: 5000  # 5 seconds

# ============================================================================
# Security Configuration
# ============================================================================
security:
  # Enable TLS/SSL encryption
  tlsenabled: false

  # Path to TLS certificate file (required if TLS enabled)
  tlscertfile: ""

  # Path to TLS private key file (required if TLS enabled)
  tlskeyfile: ""

  # Path to TLS CA certificate file (optional, for client verification)
  tlscafile: ""

  # Enable client authentication
  authenticationenabled: false

  # Authentication backend type ("file" or "ldap")
  authenticationbackend: file

  # Backend-specific authentication configuration
  authenticationconfig: {}

  # Path to authentication credentials file (for file backend)
  authenticationfilepath: ./auth.json

  # Supported SASL authentication mechanisms
  authmechanisms:
    - PLAIN

  # Enable authorization (access control)
  authorizationenabled: false

  # Default virtual host for connections
  defaultvhost: /

  # Whitelist of allowed usernames (empty = all allowed)
  allowedusers: []

  # Blacklist of blocked usernames
  blockedusers: []

  # Whitelist of allowed client hostnames/IPs (empty = all allowed)
  allowedhosts: []

  # Blacklist of blocked client hostnames/IPs
  blockedhosts: []

# ============================================================================
# Server Configuration
# ============================================================================
server:
  # Server identification name
  name: amqp-go-server

  # Server version string
  version: 0.9.1

  # Product name
  product: AMQP-Go

  # Platform identifier
  platform: Go

  # Copyright notice
  copyright: Maxpert AMQP-Go Server

  # Logging level (debug, info, warn, error)
  loglevel: info

  # Log file path (empty = stdout)
  logfile: ""

  # PID file path for daemon mode (empty = no PID file)
  pidfile: ""

  # Run as background daemon process
  daemonize: false

  # Maximum channels per client connection (AMQP spec max: 2047)
  maxchannelsperconnection: 2047

  # Maximum AMQP frame size in bytes (default: 128 KB)
  maxframesize: 131072

  # Maximum message size in bytes (default: 16 MB)
  maxmessagesize: 16777216

  # Channel operation timeout (milliseconds)
  channeltimeoutms: 60000  # 60 seconds

  # Message delivery timeout (milliseconds)
  messagetimeoutms: 30000  # 30 seconds

  # Interval for cleanup tasks (milliseconds)
  cleanupintervalms: 300000  # 5 minutes

  # Memory limit as percentage of total RAM (0-100, 0 = use absolute)
  # RabbitMQ default: 60% (triggers flow control when exceeded)
  memorylimitpercent: 60

  # Absolute memory limit in bytes (0 = use percentage)
  memorylimitbytes: 0

# ============================================================================
# Engine Configuration (Performance Tuning)
# Configurable hot-path parameters for performance optimization
# ============================================================================
engine:
  # ========================================
  # Queue State Management
  # ========================================

  # Available channel buffer size - lock-free queue of available message IDs
  # Optimized to 10M entries (80 MB per queue) for balanced memory usage
  # Larger buffer = more memory, more headroom for bursts
  # Smaller buffer = less memory, must be sized for throughput
  # Default: 10,000,000 (10M entries = 80 MB per queue)
  availablechannelbuffer: 10000000

  # ========================================
  # Ring Buffer (Hot Path)
  # ========================================

  # Ring buffer size for in-memory message storage (must be power of 2)
  # Larger = more messages in fast memory before spilling to WAL
  # Smaller = less memory, more frequent WAL writes
  # Default: 65,536 (64K messages = ~6.5 MB per queue)
  ringbuffersize: 65536

  # Spill threshold percentage (when to start writing to WAL, 0-100)
  # Higher = more tolerance for bursts, but less safety margin
  # Lower = more conservative, earlier WAL writes
  # Default: 80 (start spilling at 80% full = 51,200 messages for 64K ring)
  spillthresholdpercent: 80

  # ========================================
  # Write-Ahead Log (WAL)
  # ========================================

  # WAL batch size - how many messages to batch before flushing WAL
  # Larger = better throughput, higher latency, more data loss risk on crash
  # Smaller = lower latency, more fsync calls, lower throughput
  # Default: 1,000 messages
  walbatchsize: 1000

  # Maximum time to wait before flushing partial WAL batch (milliseconds)
  # Longer = better batching, higher latency
  # Shorter = lower latency, less efficient batching
  # Default: 10 (10ms)
  walbatchtimeoutms: 10

  # Maximum size of each WAL file before rotation (bytes)
  # Larger = fewer files, longer replay on restart
  # Smaller = more files, faster replay, more file handles
  # Default: 536,870,912 (512 MB)
  walfilesize: 536870912

  # WAL channel buffer size - buffered write/ack requests to WAL
  # Larger = more buffering for bursts, more memory
  # Smaller = less memory, potential blocking under load
  # Default: 10,000
  walchannelbuffer: 10000

  # ========================================
  # Segment Storage (Cold Path)
  # ========================================

  # Segment file size - max size of each segment file (bytes)
  # Larger = fewer files, longer compaction time
  # Smaller = more files, faster compaction, more file handles
  # Default: 1,073,741,824 (1 GB)
  segmentsize: 1073741824

  # Segment checkpoint interval - how often to checkpoint metadata (milliseconds)
  # Longer = less I/O overhead, more replay on restart
  # Shorter = more I/O overhead, faster restart
  # Default: 300000 (5 minutes)
  segmentcheckpointintervalms: 300000

  # Compaction threshold - fraction of deleted messages to trigger compaction (0.0-1.0)
  # Higher = less frequent compaction, more wasted space
  # Lower = more frequent compaction, less wasted space, more I/O
  # Default: 0.5 (50% deleted)
  compactionthreshold: 0.5

  # Compaction interval - how often to check for segments needing compaction (milliseconds)
  # Longer = less overhead checking, slower space reclamation
  # Shorter = more frequent checks, faster space reclamation
  # Default: 1800000 (30 minutes)
  compactionintervalms: 1800000

  # ========================================
  # Consumer Delivery
  # ========================================

  # Consumer select timeout - how long to wait when no messages available (milliseconds)
  # Longer = less CPU spinning, higher latency when messages arrive
  # Shorter = lower latency, more CPU usage
  # Default: 1 (500 microseconds rounded up to 1ms)
  consumerselecttimeoutms: 1

  # Consumer max batch size - max messages to deliver per consumer per poll
  # Larger = better throughput, potential unfairness between consumers
  # Smaller = better fairness, lower throughput
  # Default: 100
  consumermaxbatchsize: 100

  # ========================================
  # Background Maintenance
  # ========================================

  # Interval for checking and removing expired messages (milliseconds)
  # Longer = less overhead, slower TTL enforcement
  # Shorter = more overhead, stricter TTL enforcement
  # Default: 60000 (60 seconds)
  expiredmessagecheckintervalms: 60000

  # Interval for WAL cleanup - removing fully-processed WAL files (milliseconds)
  # Longer = slower cleanup, more disk usage
  # Shorter = faster cleanup, more overhead
  # Default: 300000 (5 minutes)
  walcleanupcheckintervalms: 300000

  # Number of acknowledged offsets to delete per cleanup cycle
  # Larger = faster cleanup, more I/O per cycle
  # Smaller = slower cleanup, less I/O impact
  # Default: 1,000
  offsetcleanupbatchsize: 1000

  # Interval for cleaning up acknowledged message offsets (milliseconds)
  # Longer = less overhead, more stale offsets in memory
  # Shorter = more overhead, cleaner memory
  # Default: 30000 (30 seconds)
  offsetcleanupintervalms: 30000
